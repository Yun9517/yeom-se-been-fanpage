"use strict";(self.webpackChunkyeom_se_been_fanpage=self.webpackChunkyeom_se_been_fanpage||[]).push([[325],{1131:(e,s,a)=>{a.d(s,{A:()=>i});var t=a(5043),n=a(6667),r=a(791);const i=function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const[i,l]=(0,t.useState)([]),[c,o]=(0,t.useState)(!0),[d,u]=(0,t.useState)(null);return(0,t.useEffect)(()=>{o(!0),u(null);const t=(0,n.rJ)(r.db,e);let i=(0,n.P)(t,...s);let c=null;return a?c=(0,n.aQ)(i,s=>{const a=s.docs.map(e=>({id:e.id,...e.data()}));l(a),o(!1),u(null),console.log(`useFirestoreCollection: Live update from ${e}.`)},s=>{console.error(`useFirestoreCollection: Live update error for ${e}:`,s),u(`\u5373\u6642\u66f4\u65b0 ${e} \u8cc7\u6599\u5931\u6557\u3002`),o(!1)}):(async()=>{try{const s=(await(0,n.GG)(i)).docs.map(e=>({id:e.id,...e.data()}));l(s),console.log(`useFirestoreCollection: Fetched data from ${e}.`)}catch(s){console.error(`useFirestoreCollection: Error fetching data from ${e}:`,s),u(`\u7121\u6cd5\u8f09\u5165 ${e} \u8cc7\u6599\uff0c\u8acb\u7a0d\u5f8c\u518d\u8a66\u3002`)}finally{o(!1)}})(),()=>{c&&c()}},[e,s,a]),{data:i,loading:c,error:d}}},7325:(e,s,a)=>{a.r(s),a.d(s,{default:()=>A});var t=a(5043),n=a(3519),r=a(1719),i=a(4282),l=a(7417),c=a(2223),o=a(4063),d=a(3722),u=a(2557),m=a(5394),h=a(4258),x=a(2678),j=a(6045),g=a(1131),v=a(6667),f=a(791),p=a(579);const A=()=>{const{user:e,authLoading:s,updateUserProfile:a,userAchievements:A,loading:y}=(0,x.J)(),[N,b]=(0,t.useState)(""),[k,C]=(0,t.useState)(!1),[w,S]=(0,t.useState)(null),[E,F]=(0,t.useState)(null),I=(0,t.useRef)(null),L=(0,t.useRef)(null),D=(0,t.useRef)(null),R=(0,t.useRef)(null),[$,_]=(0,t.useState)(!1),[H,M]=(0,t.useState)((null===e||void 0===e?void 0:e.displayName)||""),[T,B]=(0,t.useState)(!1),[G,J]=(0,t.useState)(""),q=["\ud83d\udc4d","\ud83d\ude32","\ud83e\udd7a"],z=(0,t.useMemo)(()=>[(0,v.My)("createdAt","desc"),(0,v.AB)(100)],[]),{data:O,loading:P,error:Z}=(0,g.A)("messages",z,!0),Q=(0,t.useMemo)(()=>O.slice().reverse(),[O]);(0,t.useEffect)(()=>{(()=>{var e;null===(e=I.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})})()},[Q]),(0,t.useEffect)(()=>{L.current&&(L.current.scrollTop=L.current.scrollHeight)},[P]),(0,t.useEffect)(()=>{function e(e){D.current&&!D.current.contains(e.target)&&R.current&&!R.current.contains(e.target)&&F(null)}return E&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[E]);const U=async(s,a)=>{if(!e)return;const t=(0,v.H9)(f.db,"messages",s);try{const s=await(0,v.x7)(t);if(s.exists()){const n=s.data().reactions||{},r=n[a]||[];r.includes(e.uid)?(n[a]=r.filter(s=>s!==e.uid),0===n[a].length&&delete n[a]):n[a]=[...r,e.uid],await(0,v.mZ)(t,{reactions:n})}}catch(n){console.error("Error handling reaction:",n)}F(null)};return s?(0,p.jsxs)(n.A,{className:"mt-5 text-center",children:[(0,p.jsx)(j.A,{}),(0,p.jsx)("p",{className:"mt-3",children:"\u8f09\u5165\u4f7f\u7528\u8005\u72c0\u614b..."})]}):e?(0,p.jsxs)(n.A,{className:"mt-5 chat-container",children:[(0,p.jsxs)("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[(0,p.jsx)("h2",{className:"mb-0",children:"\u7c89\u7d72\u804a\u5929\u5ba4"}),e&&!e.isAnonymous&&(0,p.jsx)(i.A,{variant:"outline-info",size:"sm",onClick:()=>{M(e.displayName||""),J(""),_(!0)},children:"\u4fee\u6539\u66b1\u7a31"})]}),(0,p.jsxs)("div",{className:"messages-area",ref:L,children:[y&&(0,p.jsx)(l.A,{animation:"border"}),Z&&(0,p.jsxs)(r.A,{variant:"danger",children:["\u7121\u6cd5\u8f09\u5165\u8a0a\u606f\uff1a",Z.message]}),(0,p.jsxs)(c.A,{children:[Q.map(s=>{var a,t;return(0,p.jsx)(c.A.Item,{className:"message-item "+(s.userId===e.uid?"sent":"received"),onMouseEnter:()=>S(s.id),onMouseLeave:()=>S(null),children:(0,p.jsx)("div",{className:"message-content",children:s.isRetracted?(0,p.jsx)("em",{className:"retracted-message",children:"\u8a0a\u606f\u5df2\u6536\u56de"}):(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("strong",{className:"message-user",children:s.userName}),(0,p.jsx)("div",{className:"message-text",children:s.text}),(0,p.jsx)("small",{className:"message-time",children:null===(a=s.createdAt)||void 0===a?void 0:a.toDate().toLocaleTimeString()}),(0,p.jsx)("div",{className:"message-toolbar "+(s.userId===e.uid?"sent":"received"),children:(w===s.id||E===s.id)&&(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(i.A,{variant:"link",className:"reaction-button",onClick:()=>F(E===s.id?null:s.id),ref:R,children:"..."}),s.userId===e.uid&&Date.now()-(null===(t=s.createdAt)||void 0===t?void 0:t.toDate().getTime())<3e5&&(0,p.jsx)(i.A,{variant:"link",className:"retract-button",onClick:()=>(async e=>{const s=(0,v.H9)(f.db,"messages",e);try{await(0,v.mZ)(s,{isRetracted:!0})}catch(a){console.error("Error retracting message:",a)}})(s.id),children:"\u6536\u56de"})]})}),w===s.id&&(0,p.jsx)("div",{className:"quick-reactions-container "+(s.userId===e.uid?"sent":"received"),children:q.map(e=>(0,p.jsx)(i.A,{variant:"link",className:"quick-reaction-button",onClick:()=>U(s.id,e),children:e},e))}),E===s.id&&(0,p.jsxs)("div",{className:"picker-container-absolute "+(s.userId===e.uid?"sent-picker":"received-picker"),ref:D,children:[" ",(0,p.jsx)(h.Ay,{onEmojiClick:e=>U(s.id,e.emoji),pickerStyle:s.userId===e.uid?{right:"0px"}:{left:"0px"}})]}),(0,p.jsx)("div",{className:"reactions-display",children:Object.entries(s.reactions||{}).map(a=>{let[t,n]=a;return n.length>0&&(0,p.jsxs)(o.A,{pill:!0,bg:n.includes(e.uid)?"primary":"secondary",className:"reaction-badge",onClick:()=>U(s.id,t),children:[t," ",n.length]},t)})})]})})},s.id)}),(0,p.jsx)("div",{ref:I})]})]}),(0,p.jsx)("div",{className:"input-picker-container",children:k&&(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(h.Ay,{onEmojiClick:e=>{b(s=>s+e.emoji)}}),(0,p.jsx)(i.A,{variant:"secondary",onClick:()=>C(!1),className:"mt-2 emoji-close-button",children:(0,p.jsx)(m.$8F,{})})]})}),(0,p.jsxs)(d.A,{onSubmit:async s=>{if(s.preventDefault(),""!==N.trim()&&e)try{await(0,v.gS)((0,v.rJ)(f.db,"messages"),{text:N,createdAt:(0,v.O5)(),userId:e.uid,userName:e.displayName||"\u533f\u540d\u7528\u6236",isRetracted:!1,reactions:{}}),b("")}catch(a){console.error("Error sending message:",a)}},className:"message-form",children:[(0,p.jsx)(d.A.Control,{type:"text",value:N,onChange:e=>b(e.target.value),placeholder:"\u8f38\u5165\u8a0a\u606f...",autoComplete:"off"}),(0,p.jsx)(i.A,{variant:"light",onClick:()=>C(e=>!e),className:"emoji-button",children:"\ud83d\ude0a"}),(0,p.jsx)(i.A,{variant:"primary",type:"submit",className:"btn-theme-gradient",children:"\u50b3\u9001"})]}),(0,p.jsxs)(u.A,{show:$,onHide:()=>_(!1),centered:!0,children:[(0,p.jsx)(u.A.Header,{closeButton:!0,className:"bg-dark text-white",children:(0,p.jsx)(u.A.Title,{children:"\u4fee\u6539\u804a\u5929\u5ba4\u66b1\u7a31"})}),(0,p.jsx)(u.A.Body,{className:"bg-dark text-white",children:(0,p.jsxs)(d.A,{onSubmit:async e=>{e.preventDefault(),J(""),B(!0);try{await a(H),_(!1)}catch(Z){J(Z.message)}finally{B(!1)}},children:[(0,p.jsxs)(d.A.Group,{className:"mb-3",children:[(0,p.jsx)(d.A.Label,{children:"\u65b0\u66b1\u7a31"}),(0,p.jsx)(d.A.Control,{type:"text",placeholder:"\u8f38\u5165\u65b0\u66b1\u7a31",value:H,onChange:e=>M(e.target.value),isInvalid:!!G,disabled:T}),(0,p.jsx)(d.A.Control.Feedback,{type:"invalid",children:G})]}),(0,p.jsxs)("div",{className:"d-flex justify-content-end",children:[(0,p.jsx)(i.A,{variant:"secondary",onClick:()=>_(!1),disabled:T,className:"me-2",children:"\u53d6\u6d88"}),(0,p.jsx)(i.A,{variant:"outline-warning",onClick:async()=>{J(""),B(!0);try{if(!e||!A||!A.initialDisplayName)throw new Error("\u5f88\u62b1\u6b49\u66ab\u6642\u7121\u6cd5\u53d6\u5f97\u521d\u59cb\u66b1\u7a31\u3002\u8acb\u5148\u81ea\u884c\u624b\u52d5\u4fee\u6539\u3002");const s=A.initialDisplayName;await a(s),_(!1)}catch(Z){J(Z.message)}finally{B(!1)}},disabled:T||y,className:"me-2",children:"\u521d\u59cb\u66b1\u7a31"}),(0,p.jsx)(i.A,{variant:"primary",type:"submit",disabled:T,children:T?(0,p.jsx)(l.A,{as:"span",animation:"border",size:"sm",role:"status","aria-hidden":"true"}):"\u5132\u5b58\u8b8a\u66f4"})]})]})})]})]}):(0,p.jsx)(n.A,{className:"mt-5",children:(0,p.jsx)(r.A,{variant:"warning",children:"\u8acb\u5148\u767b\u5165\u624d\u80fd\u4f7f\u7528\u804a\u5929\u5ba4\u3002"})})}}}]);
//# sourceMappingURL=325.e4b3e1ac.chunk.js.map