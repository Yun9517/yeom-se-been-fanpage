"use strict";(self.webpackChunkyeom_se_been_fanpage=self.webpackChunkyeom_se_been_fanpage||[]).push([[548],{1131:(e,s,r)=>{r.d(s,{A:()=>i});var t=r(5043),a=r(6667),n=r(791);const i=function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const[i,l]=(0,t.useState)([]),[c,o]=(0,t.useState)(!0),[d,u]=(0,t.useState)(null);return(0,t.useEffect)(()=>{o(!0),u(null);const t=(0,a.rJ)(n.db,e);let i=(0,a.P)(t,...s);let c=null;return r?c=(0,a.aQ)(i,s=>{const r=s.docs.map(e=>({id:e.id,...e.data()}));l(r),o(!1),u(null),console.log(`useFirestoreCollection: Live update from ${e}.`)},s=>{console.error(`useFirestoreCollection: Live update error for ${e}:`,s),u(`\u5373\u6642\u66f4\u65b0 ${e} \u8cc7\u6599\u5931\u6557\u3002`),o(!1)}):(async()=>{try{const s=(await(0,a.GG)(i)).docs.map(e=>({id:e.id,...e.data()}));l(s),console.log(`useFirestoreCollection: Fetched data from ${e}.`)}catch(s){console.error(`useFirestoreCollection: Error fetching data from ${e}:`,s),u(`\u7121\u6cd5\u8f09\u5165 ${e} \u8cc7\u6599\uff0c\u8acb\u7a0d\u5f8c\u518d\u8a66\u3002`)}finally{o(!1)}})(),()=>{c&&c()}},[e,s,r]),{data:i,loading:c,error:d}}},3548:(e,s,r)=>{r.r(s),r.d(s,{default:()=>A});var t=r(5043),a=r(3519),n=r(1719),i=r(4282),l=r(7417),c=r(2223),o=r(4063),d=r(3722),u=r(2557),m=r(5394),h=r(4258),g=r(2678),x=r(791),j=r(6667),v=r(823);var f=r(6045),p=r(1131),y=r(579);const A=()=>{const{user:e,authLoading:s,loading:r}=(0,g.J)(),{updateUserProfile:A,resetToInitialNickname:N,isUpdating:b,error:w,setError:k}=(()=>{const{user:e,userAchievements:s,fetchUserData:r}=(0,g.J)(),[a,n]=(0,t.useState)(!1),[i,l]=(0,t.useState)(null),c=(0,t.useCallback)(async s=>{if(!e||e.isAnonymous){const e=new Error("\u672a\u767b\u5165\u6216\u533f\u540d\u7528\u6236\u7121\u6cd5\u4fee\u6539\u66b1\u7a31\u3002");throw l(e),e}if(!s||""===s.trim()){const e=new Error("\u66b1\u7a31\u4e0d\u80fd\u70ba\u7a7a\u3002");throw l(e),e}n(!0),l(null);try{await(0,v.r7)(x.j.currentUser,{displayName:s.trim()});const t=(0,j.H9)(x.db,"userAchievements",e.uid);return await(0,j.BN)(t,{userName:s.trim()},{merge:!0}),await r(),n(!1),{success:!0}}catch(t){console.error("Error updating user profile:",t);const e=new Error("\u66f4\u65b0\u66b1\u7a31\u5931\u6557\uff0c\u8acb\u7a0d\u5f8c\u518d\u8a66\u3002");throw l(e),n(!1),e}},[e,r]),o=(0,t.useCallback)(async()=>{if(!e||e.isAnonymous){const e=new Error("\u672a\u767b\u5165\u6216\u533f\u540d\u7528\u6236\u7121\u6cd5\u91cd\u8a2d\u66b1\u7a31\u3002");throw l(e),e}if(!s||!s.initialDisplayName){const e=new Error("\u7121\u6cd5\u53d6\u5f97\u521d\u59cb\u66b1\u7a31\u3002");throw l(e),e}try{return await c(s.initialDisplayName),{success:!0}}catch(r){throw console.error("Error resetting nickname:",r),new Error("\u91cd\u8a2d\u66b1\u7a31\u5931\u6557\uff0c\u8acb\u7a0d\u5f8c\u518d\u8a66\u3002")}},[e,s,c]);return{updateUserProfile:c,resetToInitialNickname:o,isUpdating:a,error:i,setError:l}})(),[C,E]=(0,t.useState)(""),[S,I]=(0,t.useState)(!1),[L,F]=(0,t.useState)(null),[D,R]=(0,t.useState)(null),$=(0,t.useRef)(null),H=(0,t.useRef)(null),T=(0,t.useRef)(null),U=(0,t.useRef)(null),[_,z]=(0,t.useState)(!1),[M,J]=(0,t.useState)((null===e||void 0===e?void 0:e.displayName)||""),B=["\ud83d\udc4d","\ud83d\ude32","\ud83e\udd7a"],G=(0,t.useMemo)(()=>[(0,j.My)("createdAt","desc"),(0,j.AB)(100)],[]),{data:P,loading:q,error:O}=(0,p.A)("messages",G,!0),Z=(0,t.useRef)(P.length),Q=(0,t.useMemo)(()=>P.slice().reverse(),[P]),V=()=>{var e;null===(e=$.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};(0,t.useLayoutEffect)(()=>{H.current&&(P.length>Z.current&&V(),Z.current=P.length)},[P,P.length]),(0,t.useEffect)(()=>{H.current&&(H.current.scrollTop=H.current.scrollHeight)},[q]),(0,t.useEffect)(()=>{function e(e){T.current&&!T.current.contains(e.target)&&U.current&&!U.current.contains(e.target)&&R(null)}return D&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[D]);const Y=async(s,r)=>{if(!e)return;const t=(0,j.H9)(x.db,"messages",s);try{const s=await(0,j.x7)(t);if(s.exists()){const a=s.data().reactions||{},n=a[r]||[];n.includes(e.uid)?(a[r]=n.filter(s=>s!==e.uid),0===a[r].length&&delete a[r]):a[r]=[...n,e.uid],await(0,j.mZ)(t,{reactions:a})}}catch(a){console.error("Error handling reaction:",a)}R(null)};return s?(0,y.jsxs)(a.A,{className:"mt-5 text-center",children:[(0,y.jsx)(f.A,{}),(0,y.jsx)("p",{className:"mt-3",children:"\u8f09\u5165\u4f7f\u7528\u8005\u72c0\u614b..."})]}):e?(0,y.jsxs)(a.A,{className:"chat-container",children:[(0,y.jsxs)("div",{className:"position-relative text-center mb-3",children:[(0,y.jsx)("h2",{className:"mb-0",children:"\u7c89\u7d72\u804a\u5929\u5ba4"}),e&&!e.isAnonymous&&(0,y.jsx)(i.A,{variant:"outline-info",size:"sm",onClick:()=>{J(e.displayName||""),k(null),z(!0)},style:{position:"absolute",right:0,top:"50%",transform:"translateY(-50%)"},children:"\u4fee\u6539\u66b1\u7a31"})]}),(0,y.jsxs)("div",{className:"messages-area",ref:H,children:[r&&(0,y.jsx)(l.A,{animation:"border"}),O&&(0,y.jsxs)(n.A,{variant:"danger",children:["\u7121\u6cd5\u8f09\u5165\u8a0a\u606f\uff1a",O.message]}),(0,y.jsxs)(c.A,{children:[Q.map(s=>{var r,t;return(0,y.jsx)(c.A.Item,{className:"message-item "+(s.userId===e.uid?"sent":"received"),onMouseEnter:()=>F(s.id),onMouseLeave:()=>F(null),children:(0,y.jsx)("div",{className:"message-content",children:s.isRetracted?(0,y.jsx)("em",{className:"retracted-message",children:"\u8a0a\u606f\u5df2\u6536\u56de"}):(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)("strong",{className:"message-user",children:s.userName}),(0,y.jsx)("div",{className:"message-text",children:s.text}),(0,y.jsx)("small",{className:"message-time",children:null===(r=s.createdAt)||void 0===r?void 0:r.toDate().toLocaleTimeString()}),(0,y.jsx)("div",{className:"message-toolbar "+(s.userId===e.uid?"sent":"received"),children:(L===s.id||D===s.id)&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(i.A,{variant:"link",className:"reaction-button",onClick:()=>R(D===s.id?null:s.id),ref:U,children:"..."}),s.userId===e.uid&&Date.now()-(null===(t=s.createdAt)||void 0===t?void 0:t.toDate().getTime())<3e5&&(0,y.jsx)(i.A,{variant:"link",className:"retract-button",onClick:()=>(async e=>{const s=(0,j.H9)(x.db,"messages",e);try{await(0,j.mZ)(s,{isRetracted:!0})}catch(r){console.error("Error retracting message:",r)}})(s.id),children:"\u6536\u56de"})]})}),L===s.id&&(0,y.jsx)("div",{className:"quick-reactions-container "+(s.userId===e.uid?"sent":"received"),children:B.map(e=>(0,y.jsx)(i.A,{variant:"link",className:"quick-reaction-button",onClick:()=>Y(s.id,e),children:e},e))}),D===s.id&&(0,y.jsxs)("div",{className:"picker-container-absolute "+(s.userId===e.uid?"sent-picker":"received-picker"),ref:T,children:[" ",(0,y.jsx)(h.Ay,{onEmojiClick:e=>Y(s.id,e.emoji),height:350,width:250,className:"reaction-emoji-picker"})]}),(0,y.jsx)("div",{className:"reactions-display",children:Object.entries(s.reactions||{}).map(r=>{let[t,a]=r;return a.length>0&&(0,y.jsxs)(o.A,{pill:!0,bg:a.includes(e.uid)?"primary":"secondary",className:"reaction-badge",onClick:()=>Y(s.id,t),children:[t," ",a.length]},t)})})]})})},s.id)}),(0,y.jsx)("div",{ref:$})]})]}),(0,y.jsx)("div",{className:"input-picker-container",children:S&&(0,y.jsxs)(y.Fragment,{children:[(0,y.jsx)(h.Ay,{onEmojiClick:e=>{E(s=>s+e.emoji)}}),(0,y.jsx)(i.A,{variant:"secondary",onClick:()=>I(!1),className:"mt-2 emoji-close-button",children:(0,y.jsx)(m.$8F,{})})]})}),(0,y.jsxs)(d.A,{onSubmit:async s=>{if(s.preventDefault(),""===C.trim()||!e)return;const r=C.toLowerCase();if(["\u767d\u7661","\u7d04\u8dd1","\u8272\u8272","\u60f3\u8272"].some(e=>r.includes(e.toLowerCase())))alert("\u60a8\u7684\u8a0a\u606f\u5305\u542b\u4e0d\u7576\u8a00\u8ad6\uff0c\u7121\u6cd5\u50b3\u9001\u3002");else try{await(0,j.gS)((0,j.rJ)(x.db,"messages"),{text:C,createdAt:(0,j.O5)(),userId:e.uid,userName:e.displayName||"\u533f\u540d\u7528\u6236",isRetracted:!1,reactions:{}}),E(""),V()}catch(t){console.error("Error sending message:",t)}},className:"message-form",children:[(0,y.jsx)(d.A.Control,{size:"md",type:"text",value:C,onChange:e=>E(e.target.value),placeholder:"\u8f38\u5165\u8a0a\u606f...",autoComplete:"off"}),(0,y.jsx)(i.A,{size:"md",variant:"light",onClick:()=>I(e=>!e),className:"emoji-button",children:"\ud83d\ude0a"}),(0,y.jsx)(i.A,{size:"md",variant:"primary",type:"submit",className:"btn-theme-gradient",children:"\u50b3\u9001"})]}),(0,y.jsxs)(u.A,{show:_,onHide:()=>z(!1),centered:!0,dialogClassName:"nickname-modal",children:[(0,y.jsx)(u.A.Header,{className:"bg-dark text-white",children:(0,y.jsx)(u.A.Title,{children:"\u4fee\u6539\u804a\u5929\u5ba4\u66b1\u7a31"})}),(0,y.jsx)(u.A.Body,{className:"bg-dark text-white",children:(0,y.jsxs)(d.A,{onSubmit:async e=>{e.preventDefault();try{await A(M),z(!1)}catch(s){console.error(s.message)}},children:[(0,y.jsxs)(d.A.Group,{className:"mb-3",children:[(0,y.jsx)(d.A.Label,{children:"\u65b0\u66b1\u7a31"}),(0,y.jsx)(d.A.Control,{type:"text",placeholder:"\u8f38\u5165\u65b0\u66b1\u7a31",value:M,onChange:e=>J(e.target.value),isInvalid:!!w,disabled:b}),(0,y.jsx)(d.A.Control.Feedback,{type:"invalid",children:null===w||void 0===w?void 0:w.message})]}),(0,y.jsxs)("div",{className:"d-flex justify-content-end",children:[(0,y.jsx)(i.A,{variant:"secondary",onClick:()=>z(!1),disabled:b,className:"me-2",children:"\u53d6\u6d88"}),(0,y.jsx)(i.A,{variant:"outline-warning",onClick:async()=>{try{await N(),z(!1)}catch(e){console.error(e.message)}},disabled:b||r,className:"me-2",children:"\u521d\u59cb\u66b1\u7a31"}),(0,y.jsx)(i.A,{variant:"primary",type:"submit",disabled:b,children:b?(0,y.jsx)(l.A,{as:"span",animation:"border",size:"sm",role:"status","aria-hidden":"true"}):"\u5132\u5b58\u8b8a\u66f4"})]})]})})]})]}):(0,y.jsx)(a.A,{className:"mt-5",children:(0,y.jsx)(n.A,{variant:"warning",children:"\u8acb\u5148\u767b\u5165\u624d\u80fd\u4f7f\u7528\u804a\u5929\u5ba4\u3002"})})}}}]);
//# sourceMappingURL=548.a7c8cb4a.chunk.js.map