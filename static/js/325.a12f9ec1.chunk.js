"use strict";(self.webpackChunkyeom_se_been_fanpage=self.webpackChunkyeom_se_been_fanpage||[]).push([[325],{1131:(e,s,t)=>{t.d(s,{A:()=>i});var r=t(5043),a=t(6667),n=t(791);const i=function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const[i,c]=(0,r.useState)([]),[l,o]=(0,r.useState)(!0),[d,u]=(0,r.useState)(null);return(0,r.useEffect)(()=>{o(!0),u(null);const r=(0,a.rJ)(n.db,e);let i=(0,a.P)(r,...s);let l=null;return t?l=(0,a.aQ)(i,s=>{const t=s.docs.map(e=>({id:e.id,...e.data()}));c(t),o(!1),u(null),console.log(`useFirestoreCollection: Live update from ${e}.`)},s=>{console.error(`useFirestoreCollection: Live update error for ${e}:`,s),u(`\u5373\u6642\u66f4\u65b0 ${e} \u8cc7\u6599\u5931\u6557\u3002`),o(!1)}):(async()=>{try{const s=(await(0,a.GG)(i)).docs.map(e=>({id:e.id,...e.data()}));c(s),console.log(`useFirestoreCollection: Fetched data from ${e}.`)}catch(s){console.error(`useFirestoreCollection: Error fetching data from ${e}:`,s),u(`\u7121\u6cd5\u8f09\u5165 ${e} \u8cc7\u6599\uff0c\u8acb\u7a0d\u5f8c\u518d\u8a66\u3002`)}finally{o(!1)}})(),()=>{l&&l()}},[e,s,t]),{data:i,loading:l,error:d}}},7325:(e,s,t)=>{t.r(s),t.d(s,{default:()=>p});var r=t(5043),a=t(3519),n=t(1719),i=t(7417),c=t(2223),l=t(4282),o=t(4063),d=t(3722),u=t(5394),m=t(4258),h=t(2678),g=t(6045),x=t(1131),j=t(6667),v=t(791),f=t(579);const p=()=>{const{user:e,authLoading:s}=(0,h.J)(),[t,p]=(0,r.useState)(""),[N,A]=(0,r.useState)(!1),[b,y]=(0,r.useState)(null),[k,C]=(0,r.useState)(null),E=(0,r.useRef)(null),w=(0,r.useRef)(null),S=(0,r.useRef)(null),F=(0,r.useRef)(null),I=["\ud83d\udc4d","\ud83d\ude32","\ud83e\udd7a"],L=(0,r.useMemo)(()=>[(0,j.My)("createdAt","desc"),(0,j.AB)(100)],[]),{data:R,loading:$,error:_}=(0,x.A)("messages",L,!0),M=(0,r.useMemo)(()=>R.slice().reverse(),[R]);(0,r.useEffect)(()=>{(()=>{var e;null===(e=E.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})})()},[M]),(0,r.useEffect)(()=>{w.current&&(w.current.scrollTop=w.current.scrollHeight)},[$]),(0,r.useEffect)(()=>{function e(e){S.current&&!S.current.contains(e.target)&&F.current&&!F.current.contains(e.target)&&C(null)}return k&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[k]);const D=async(s,t)=>{if(!e)return;const r=(0,j.H9)(v.db,"messages",s);try{const s=await(0,j.x7)(r);if(s.exists()){const a=s.data().reactions||{},n=a[t]||[];n.includes(e.uid)?(a[t]=n.filter(s=>s!==e.uid),0===a[t].length&&delete a[t]):a[t]=[...n,e.uid],await(0,j.mZ)(r,{reactions:a})}}catch(a){console.error("Error handling reaction:",a)}C(null)};return s?(0,f.jsxs)(a.A,{className:"mt-5 text-center",children:[(0,f.jsx)(g.A,{}),(0,f.jsx)("p",{className:"mt-3",children:"\u8f09\u5165\u4f7f\u7528\u8005\u72c0\u614b..."})]}):e?(0,f.jsxs)(a.A,{className:"mt-5 chat-container",children:[(0,f.jsx)("h2",{className:"mb-4",children:"\u7c89\u7d72\u804a\u5929\u5ba4"}),(0,f.jsxs)("div",{className:"messages-area",ref:w,children:[$&&(0,f.jsx)(i.A,{animation:"border"}),_&&(0,f.jsxs)(n.A,{variant:"danger",children:["\u7121\u6cd5\u8f09\u5165\u8a0a\u606f\uff1a",_.message]}),(0,f.jsxs)(c.A,{children:[M.map(s=>{var t,r;return(0,f.jsx)(c.A.Item,{className:"message-item "+(s.userId===e.uid?"sent":"received"),onMouseEnter:()=>y(s.id),onMouseLeave:()=>y(null),children:(0,f.jsx)("div",{className:"message-content",children:s.isRetracted?(0,f.jsx)("em",{className:"retracted-message",children:"\u8a0a\u606f\u5df2\u6536\u56de"}):(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)("strong",{className:"message-user",children:s.userName}),(0,f.jsx)("div",{className:"message-text",children:s.text}),(0,f.jsx)("small",{className:"message-time",children:null===(t=s.createdAt)||void 0===t?void 0:t.toDate().toLocaleTimeString()}),(0,f.jsx)("div",{className:"message-toolbar "+(s.userId===e.uid?"sent":"received"),children:(b===s.id||k===s.id)&&(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(l.A,{variant:"link",className:"reaction-button",onClick:()=>C(k===s.id?null:s.id),ref:F,children:"..."}),s.userId===e.uid&&Date.now()-(null===(r=s.createdAt)||void 0===r?void 0:r.toDate().getTime())<3e5&&(0,f.jsx)(l.A,{variant:"link",className:"retract-button",onClick:()=>(async e=>{const s=(0,j.H9)(v.db,"messages",e);try{await(0,j.mZ)(s,{isRetracted:!0})}catch(t){console.error("Error retracting message:",t)}})(s.id),children:"\u6536\u56de"})]})}),b===s.id&&(0,f.jsx)("div",{className:"quick-reactions-container "+(s.userId===e.uid?"sent":"received"),children:I.map(e=>(0,f.jsx)(l.A,{variant:"link",className:"quick-reaction-button",onClick:()=>D(s.id,e),children:e},e))}),k===s.id&&(0,f.jsxs)("div",{className:"picker-container-absolute "+(s.userId===e.uid?"sent-picker":"received-picker"),ref:S,children:[" ",(0,f.jsx)(m.Ay,{onEmojiClick:e=>D(s.id,e.emoji),pickerStyle:s.userId===e.uid?{right:"0px"}:{left:"0px"}})]}),(0,f.jsx)("div",{className:"reactions-display",children:Object.entries(s.reactions||{}).map(t=>{let[r,a]=t;return a.length>0&&(0,f.jsxs)(o.A,{pill:!0,bg:a.includes(e.uid)?"primary":"secondary",className:"reaction-badge",onClick:()=>D(s.id,r),children:[r," ",a.length]},r)})})]})})},s.id)}),(0,f.jsx)("div",{ref:E})]})]}),(0,f.jsx)("div",{className:"input-picker-container",children:N&&(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(m.Ay,{onEmojiClick:e=>{p(s=>s+e.emoji)}}),(0,f.jsx)(l.A,{variant:"secondary",onClick:()=>A(!1),className:"mt-2 emoji-close-button",children:(0,f.jsx)(u.$8F,{})})]})}),(0,f.jsxs)(d.A,{onSubmit:async s=>{if(s.preventDefault(),""!==t.trim()&&e)try{await(0,j.gS)((0,j.rJ)(v.db,"messages"),{text:t,createdAt:(0,j.O5)(),userId:e.uid,userName:e.displayName||"\u533f\u540d\u7528\u6236",isRetracted:!1,reactions:{}}),p("")}catch(r){console.error("Error sending message:",r)}},className:"message-form",children:[(0,f.jsx)(d.A.Control,{type:"text",value:t,onChange:e=>p(e.target.value),placeholder:"\u8f38\u5165\u8a0a\u606f...",autoComplete:"off"}),(0,f.jsx)(l.A,{variant:"light",onClick:()=>A(e=>!e),className:"emoji-button",children:"\ud83d\ude0a"}),(0,f.jsx)(l.A,{variant:"primary",type:"submit",className:"btn-theme-gradient",children:"\u50b3\u9001"})]})]}):(0,f.jsx)(a.A,{className:"mt-5",children:(0,f.jsx)(n.A,{variant:"warning",children:"\u8acb\u5148\u767b\u5165\u624d\u80fd\u4f7f\u7528\u804a\u5929\u5ba4\u3002"})})}}}]);
//# sourceMappingURL=325.a12f9ec1.chunk.js.map